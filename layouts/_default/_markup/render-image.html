{{- $src := .Destination -}}

{{/* 1. Если путь НЕ начинается с "/" — это локальный ресурс страницы */}}
{{- if not (hasPrefix $src "/") -}}
  {{- $image := .Page.Resources.GetMatch $src -}}
  {{- if $image -}}
    {{- $resized := $image.Resize "825x" -}}
    {{- $dir := path.Dir $resized.RelPermalink -}}
    {{- $base := path.Base $resized.RelPermalink -}}
    {{- $fixedBase := $base | replaceRE "%" "%25" | replaceRE `\\` "%5C" -}}
    {{- $fixedURL := printf "%s/%s" $dir $fixedBase -}}
    <img src="{{ $fixedURL }}" alt="{{ .Text }}" class="img-fluid">
  {{- else -}}
    <!-- Fallback: если не найдено рядом -->
    <img src="{{ $src | relURL }}" alt="{{ .Text }}" class="img-fluid">
  {{- end -}}
{{/* 2. Если путь начинается с "/" — это глобальный ресурс из /assets/ */}}
{{- else -}}
  {{- $relPath := strings.TrimPrefix "/" $src -}}
  {{- $image := resources.Get $relPath -}}
  {{- if $image -}}
    {{- $resized := $image.Resize "825x" -}}
    {{- $dir := path.Dir $resized.RelPermalink -}}
    {{- $base := path.Base $resized.RelPermalink -}}
    {{- $fixedBase := $base | replaceRE "%" "%25" | replaceRE `\\` "%5C" -}}
    {{- $fixedURL := printf "%s/%s" $dir $fixedBase -}}
    <img src="{{ $fixedURL }}" alt="{{ .Text }}" class="img-fluid">
  {{- else -}}
    <!-- Fallback: если не найдено в assets -->
    <img src="{{ $src | absURL }}" alt="{{ .Text }}" class="img-fluid">
  {{- end -}}
{{- end -}}
